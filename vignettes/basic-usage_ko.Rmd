---
title: "Basic Usage"
author: "Martin Hinz(translation:Chanhyeok-Ju)"
output:
  github_document
vignette: >
  %\VignetteIndexEntry{Basic Usage}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

[ENG](vignettes/basic-usage.Rmd) / [KOR](vignettes/basic-usage_ko.Rmd)

`oxcAAR`은 R과 [Oxcal](https://c14.arch.ox.ac.uk) 사이의 인터페이스를 나타내도록 설계되었습니다. 이를 통해 R 내에서 OxCal 스크립트를 실행하고, 분석 결과를 불러올 수 있습니다. 물론 Bchron과 같은 다른 패키지들을 통해 더 빠르게 <sup>14</sup>C 데이터 보정할 수 있습니다. 하지만 OxCal은 오늘날 고고학 연구의 준표준이며 `oxcAAR`은 이러한 Oxcal을 활용할 수 있는 패키지입니다.

## 연대보정 (R_Date)

5000BP +- 25년인 연대측정치를 보정한다고 가정하겠습니다. 우리는 `oxcAAR`의 `oxcalCalibrate` 함수를 통해 연대보정을 실행할 수 있습니다. 그러나 먼저 패키지를 불러오고 [Oxcal distribution](https://c14.arch.ox.ac.uk/OxCalDistribution.zip)의 로컬 주소를 알고있어야 합니다. 이후 BP, Std 및 분석명을 사용하여 연대보정을 할 수 있습니다.

```{r,fig.width=7,fig.height=4}
library(ggplot2)
library(oxcAAR)
quickSetupOxcal()
#setOxcalExecutablePath("~/OxCal/bin/OxCalLinux")
my_date <- oxcalCalibrate(5000,25,"KIA-12345")
my_date
plot(my_date)
```

여러 연대측정치를 동시에 보정하는 것이 가능합니다.:

```{r,fig.width=7,fig.height=4}
my_uncal_dates <- data.frame(bp=c(5000,4500,4000),
                             std=c(45,35,25),
                             names=c("Date 1", "Date 2", "Date 3")
                             )
my_cal_dates <- oxcalCalibrate(my_uncal_dates$bp, my_uncal_dates$std, my_uncal_dates$names)
my_cal_dates
plot(my_cal_dates)
```

보정곡선에 그래프를 그리는 것이 가능합니다.:

```{r,fig.width=7,fig.height=4}
calcurve_plot(my_cal_dates)
```

보정결과 객체는 `oxcAARCalibratedDatesList` 클래스의 `List`이고, `oxcAARCalibratedDate` 클래스의 요소를 포함하고 있습니다. 이러한 각각의 연대들은 본래의 확률을 포함하기 때문에 필수적이며, 추가 분석을 위해 추출하여 활용할 수 있습니다.

```{r}
str(my_cal_dates, max.level = 1)
my_cal_dates[[1]] # equivalent to my_cal_dates[["Date 1"]] or my_cal_dates$`Date 1`
str(my_cal_dates$`Date 1`)
plot(
  my_cal_dates$`Date 1`$raw_probabilities$dates,
  my_cal_dates$`Date 1`$raw_probabilities$probabilities,
  type = "l",
  xlab = "years",
  ylab = "probs"
  )
```

## 시뮬레이션 (R_Simulate)

`oxcAAR`을 사용하여 OxCal의 R_Simulate 함수와 같은 방법으로 <sup>14</sup>C 연대 시뮬레이션을 실행할 수 있습니다. 보정된 연대(Ex. A.D. 1000 : 1000 / B.C. 1000 : -1000)를 입력하면 OxCal이 무작위로 BP값을 시뮬레이션합니다. 결과적으로 각각의 시뮬레이션은 약간 다른 값을 갖게 됩니다.

```{r,fig.width=7,fig.height=4}
my_cal_date <- data.frame(bp=c(-3400),
                             std=c(25),
                             names=c("SimDate_1")
                             )
my_simulated_dates <- oxcalSimulate(my_cal_date$bp,
                                    my_cal_date$std,
                                    my_cal_date$names
                                    )
# equivalent to
my_simulated_dates <- oxcalSimulate(-3400, 25, "SimDate_1")
my_simulated_dates
plot(my_simulated_dates)
```

## 합산 보정연대 시뮬레이션

본래 이 패키지는 합산 보정연대를 다루는 일련의 논고를 위해 만들어졌습니다. 합산 보정연대를 시뮬레이션하는 기능이 구현된 이유이기도 합니다. 이 함수를 활용하여 <sup>14</sup>C 연대를 시뮬레이션하고 보정된 결과를 살펴볼 수 있습니다. 시뮬레이션에 사용될 시간 범위의 시작연도와 마지막연도, 시뮬레이션해야하는 <sup>14</sup>C 연대의 수, 표준편차, 길이가 n인 벡터 혹은 모든 연대에 대한 하나의 값, 사용할 분포 유형(동일 시간 간격 혹은 무작위한 균일)을 지정하여 시뮬레이션할 수 있습니다. 시뮬레이션 결과는 `oxcAARCalibratedDate` 클래스로 환원되므로 본래의 확률과 액세스하여 추가적인 분석을 시행할 수 있습니다.:

```{r,fig.width=7,fig.height=4}
my_sum_sim<-oxcalSumSim(
  timeframe_begin = -4000,
  timeframe_end = -3000,
  n = 50,
  stds = 35,
  date_distribution = "uniform"
  )
str(my_sum_sim)
plot(my_sum_sim)
```

## 사용자지정 OxCal 코드 실행

이 패키지를 통해 R 내에서 사용자가 작성한 OxCal 코드를 실행하고 결과를 자신의 워크스페이스로 불러올 수 있습니다. `R_Date`, `R_Simulate`, `oxcal_Sum`을 사용하여 코드를 구성할 수 있습니다.:

```{r, echo=F}
library(knitr)
hook_output <- knit_hooks$get("output")
knit_hooks$set(output = function(x, options) {
   lines <- options$output.lines
   if (is.null(lines)) {
     return(hook_output(x, options))  # pass to default hook
   }
   x <- unlist(strsplit(x, "\n"))
   more <- "..."
   if (length(lines)==1) {        # first n lines
     if (length(x) > lines) {
       # truncate the output, but add ....
       x <- c(head(x, lines), more)
     }
   } else {
     x <- c(more, x[lines], more)
   }
   # paste these lines together
   x <- paste(c(x, ""), collapse = "\n")
   hook_output(x, options)
 })
```

```{r}
R_Simulate(-4000, 25, "MySimDate")
my_dates <- R_Date(c("Lab-12345","Lab-54321"), c(5000,4500), 25)
cat(my_dates)
my_sum <- oxcal_Sum(my_dates)
cat(my_sum)
```

또한 문자열로 사용자가 스크립트를 작성할 수 있습니다.:

```{r, output.lines=8}
knitr::opts_chunk$set(cache=TRUE)
my_oxcal_code <- ' Plot()
 {
  Sequence("Sequence1")
  {
   Boundary("Beginn");
   Phase("Phase1")
   {
    R_Date("Lab-1",5000,25);
    R_Date("Lab-2",4900,37);
   };
   Boundary("Between");
   Phase("Phase2")
   {
    R_Date("Lab-3",4800,43);
   };
   Boundary("End");
  };
 };'
my_result_file <- executeOxcalScript(my_oxcal_code)
my_result_text <- readOxcalOutput(my_result_file)
```

결과를 oxcAAR 표준 객체로 얻을 수 있습니다.:

```{r, output.lines=8}
my_result_data <- parseOxcalOutput(my_result_text)
str(my_result_data)
print(my_result_data)
```

또는 전체 출력을 OxCal 객체로 얻을 수도 있습니다.:

```{r, output.lines=8}
my_result_data <- parseFullOxcalOutput(my_result_text)
str(my_result_data)
```
